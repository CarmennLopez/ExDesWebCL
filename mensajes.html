<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - Enviar Mensaje</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <style>
    body {
      background: linear-gradient(135deg,#2575fc,#6a11cb);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .card {
      width: 100%;
      max-width: 500px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
      padding: 25px;
    }
  </style>
</head>

<body>
  <div class="card bg-white">
    <h3 class="text-center text-primary fw-bold mb-2">üí¨ Chat - Env√≠o de Mensajes</h3>
    
    <p id="userInfo" class="text-center fw-semibold text-secondary"></p>

    <textarea id="mensaje" class="form-control" rows="4" placeholder="Escribe tu mensaje..."></textarea>

    <button class="btn btn-success w-100 mt-3" onclick="enviarMensaje()">Enviar üì®</button>

    <p id="status" class="text-center fw-bold mt-3"></p>

    <button class="btn btn-danger w-100 mt-2" onclick="cerrarSesion()">Cerrar sesi√≥n üö™</button>
  </div>

<script>
  // Obtener datos guardados en la Serie I
  const token = sessionStorage.getItem("token");
  const usuario = sessionStorage.getItem("usuario");

  const info = document.getElementById("userInfo");
  const statusTxt = document.getElementById("status");

  // Validar si hay sesi√≥n activa
  if (!token || !usuario) {
    alert("‚ö† Debes iniciar sesi√≥n primero");
    window.location.href = "index.html";
  } else {
    info.textContent = "Sesi√≥n activa como: " + usuario;
  }

  async function enviarMensaje() {
    const mensaje = document.getElementById("mensaje").value.trim();

    if (!mensaje) {
      statusTxt.textContent = "‚ö† Escribe un mensaje antes de enviar";
      statusTxt.className = "text-danger text-center fw-bold";
      return;
    }

    try {
      const resp = await fetch("https://backcvbgtmdesa.azurewebsites.net/api/Mensajes", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({
          Cod_Sala: 0,
          Login_Emisor: usuario,
          Contenido: mensaje
        })
      });

      if (resp.ok) {
        statusTxt.textContent = "‚úî Mensaje enviado correctamente";
        statusTxt.className = "text-success text-center fw-bold";
        document.getElementById("mensaje").value = "";
      } else {
        statusTxt.textContent = "‚ùå Error al enviar mensaje: " + resp.status;
        statusTxt.className = "text-danger text-center fw-bold";
      }

    } catch (error) {
      statusTxt.textContent = "‚ùå Error de red o conexi√≥n";
      statusTxt.className = "text-danger text-center fw-bold";
    }
  }

  function cerrarSesion() {
    sessionStorage.clear();
    window.location.href = "index.html";
  }
</script>

</body>
</html>
